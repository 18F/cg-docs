---
menu:
  docs:
    parent: apps
title: S3 access
---

You can store application content in S3 using a [managed service]({{< relref "docs/apps/managed-services.md" >}}) that provides direct access to S3.

## Enable S3 for the application

First check whether your account has S3 available: `cf marketplace`.  If the S3 service isn't listed, ask [cloud.gov support]({{< relref "docs/help.md" >}}) to enable S3 access for your account.

Once you confirm S3 is available, start the service and [bind it to your application]({{< relref "docs/apps/managed-services.md#bind-the-service-instance" >}}). Or if you only need S3, you can create an application only for S3.

### Create an application only for S3

If you only need a S3 bucket, you can create a simple Static application:

```bash
mkdir s3-app
cd s3-app
touch Staticfile
cf push
```

### Add S3 to an application

Once an application is running in cloud.gov, the next step is to create and assign S3 to the application:

First decide if the S3 bucket contents should be private or public. Objects placed in a private bucket are only accessible using the bucket credentials unless specifically [shared with others](http://docs.aws.amazon.com/AmazonS3/latest/dev/ShareObjectPreSignedURL.html). Objects placed in a public bucket are accessible to anyone with the link.

To create a private bucket use the `basic` plan:

```bash
cf create-service s3 basic <APP_NAME>-s3
```

To create a public bucket use the `basic-public` plan:

```bash
cf create-service s3 basic-public <APP_NAME>-s3
```

Then bind the bucket to your application:

```bash
cf bind-service <APP_NAME> <APP_NAME>-s3
cf restage <APP_NAME>
```

This will put the S3 access information in the application's ENVIRONMENT variables, which you can view with `cf env <APP_NAME>`.

If you get an error, see the [managed service documentation]({{< relref "docs/apps/managed-services.md#paid-services" >}}).

## Get S3 bucket credentials

Typically to interact with S3 the [AWS Command Line Interface](https://aws.amazon.com/cli/) is used.  The Amazon CLI needs the following ENVIRONMENT variables:

* `AWS_ACCESS_KEY_ID`
* `AWS_SECRET_ACCESS_KEY`
* `AWS_DEFAULT_REGION`

These environment variables contain the credentials to access your S3 bucket. Treat the contents of these and all other environment variables as sensitive.

You can download the [jq](https://stedolan.github.io/jq/) tool to get this information by pasting the below (or run `cf env` and cut and paste from it):

```bash
export APP_NAME=your-app-name-here

export S3_CREDENTIALS=`cf env $APP_NAME | tail -n +5 | jq -r '.VCAP_SERVICES.s3 // empty' 2>/dev/null`

export AWS_ACCESS_KEY_ID=`echo "${S3_CREDENTIALS}" | jq -r .[].credentials.access_key_id`
export AWS_SECRET_ACCESS_KEY=`echo "${S3_CREDENTIALS}" | jq -r .[].credentials.secret_access_key`
export BUCKET_NAME=`echo "${S3_CREDENTIALS}" | jq -r .[].credentials.bucket`
export AWS_DEFAULT_REGION=`echo "${S3_CREDENTIALS}" | jq -r '.[].credentials.region // "us-east-1"'`
```

This will set the `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_DEFAULT_REGION` and `BUCKET_NAME`, enabling the CLI tool to add, download and modify files as needed:


```bash
# Copy a file
aws s3 cp ./mylocalfile s3://${BUCKET_NAME}/

# Download a file
aws s3 cp s3://${BUCKET_NAME}/mys3file .

# See all files
aws s3 ls s3://${BUCKET_NAME}
```

## Bucket URLs
Objects in your bucket can be accessed via the following endpoint:

* `https://s3-${AWS_DEFAULT_REGION}.amazonaws.com/${BUCKET_NAME}/`

If you plan to enable "Wwbsite mode" for the bucket and use it that way, you will need to use a different version of the URL:

* `http://${BUCKET_NAME}.s3-website-${AWS_DEFAULT_REGION}.amazonaws.com/`

Note that "website mode" URLs don't support HTTPS, and they aren't appropriate for production use unless fronted by a CloudFront distribution.

Either way, if the bucket is private, attempting to access resources will result in `AccessDenied` errors unless your application generates [pre-signed URLs](http://docs.aws.amazon.com/AmazonS3/latest/dev/ShareObjectPreSignedURL.html) for objects that need to be shared.

## Allow access from other applications
If you wish to access your S3 buckets from outside an application, you can set a CORS policy, which loosens security restrictions.  We do *NOT* recommend this, but with a sufficiently restricted list of sites and methods, it can be safe:

```bash
# Adjust CORS AllowedOrigins to known locations such as a IP address
cat << EOF > cors.json
{
  "CORSRules": [
    {
      "AllowedOrigins": ["YOUR.OTHER.APP.IP"],
      "AllowedHeaders": ["*"],
      "AllowedMethods": ["HEAD", "GET"],
      "ExposeHeaders": ["ETag"]
    }
  ]
}
EOF

# Upload the CORS policy to the bucket
aws s3api put-bucket-cors --bucket $BUCKET_NAME --cors-configuration file://cors.json
```

You can add additional method types along with HEAD and GET (such as PUT, POST, and DELETE) as needed.

## Backup and retention
By default, S3 data will stay where it is until `cf delete-service` is run on the `<APP_NAME>-s3` service.  This is not a substitue for backups, and it provides no protection from users accidentally deleting the contents.  

You can implement a backup scheme by storing your buckets under /data/year/month/day and keeping multiple copies in S3, using the AWS CLI. Your Org Manager can create a space called "backups", and your team can run the process above again to create backup buckets.
